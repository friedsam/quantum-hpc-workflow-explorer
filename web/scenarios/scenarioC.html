<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scenario C – Frame Player</title>

  <!-- Inter (Medium=500) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { background:#111; color:#eee; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { width: 1000px; margin: 20px auto; }
    .row { margin-top: 10px; display:flex; gap:8px; align-items:center; }
    button { padding:6px 10px; }
    .mono { font-family: ui-monospace, Menlo, monospace; opacity:.85; }

    /* stage + overlay */
    .stage{
      position: relative;
      width: 1000px;
      margin: 12px auto;
      aspect-ratio: 1240 / 407;
      background:#000;
      border-radius: 8px;
      overflow:hidden;
      visibility:hidden;            /* hidden until preload done */
    }
    .stage.ready{ visibility:visible; }

    /* IMPORTANT: no opacity transitions for the images (avoids blinking in fast loop) */
    .bg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border-radius:8px;
      display:block;
      opacity:0;
    }
    .bg.show{ opacity:1; }

    .overlay { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

    /* animated flow */
    .flow{
      stroke:#fff;
      stroke-width:6;
      stroke-linecap:round;
      stroke-dasharray:18 18;
      animation: dash 0.7s linear infinite;
      opacity:0;
    }
    .flow.on{ opacity:0.95; }
    @keyframes dash { to { stroke-dashoffset:-36; } }

    /* Number overlays (only used in C1a loop by default) */
    .nums{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
    }
    .nums.on{ opacity:1; }

    /* make these ALWAYS black */
    #nIdle,
    #nBlocked{
      color:#000;
      text-shadow:none;
    }

    /* Same overlay box approach as B */
    .hpcBox{
      position:absolute;
      left: 2.2%;
      top: 25.5%;
      width: 26.5%;
      height: 60%;
    }
    .num{
      position:absolute;
      right: 7%;
      font-weight: 500;            /* Inter Medium */
      color:#fff;
      font-size: 30px;             /* change to 36px if you want */
      line-height:1;
      text-shadow: 0 1px 2px rgba(0,0,0,0.55);
    }
    #nWorking { top: 13%; }
    #nBlocked { top: 77.5%; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="mono" id="status"></div>

    <div class="stage" id="stage">
      <!-- keep these stable; stage is hidden until preload finishes -->
      <img id="frameA" class="bg show" src="about:blank" alt="">
      <img id="frameB" class="bg"      src="about:blank" alt="">

      <!-- NUMBER OVERLAYS -->
      <div id="nums" class="nums">
        <div class="hpcBox">
          <div class="num" id="nWorking"></div>
          <div class="num" id="nBlocked"></div>
        </div>
      </div>

      <!-- FLOW OVERLAYS (same geometry as B; adjust if C differs) -->
      <svg class="overlay" viewBox="0 0 1240 407" preserveAspectRatio="none">
        <!-- TOP (send) segments -->
        <line id="sendL" x1="380" y1="182" x2="500" y2="182" class="flow" />
        <line id="sendR" x1="740" y1="182" x2="800" y2="182" class="flow" />

        <!-- BOTTOM (return) segments -->
        <line id="retL"  x1="500" y1="348" x2="430" y2="348" class="flow" />
        <line id="retR"  x1="1030" y1="348" x2="745" y2="348" class="flow" />
      </svg>
    </div>

    <div class="row">
      <button id="play">Pause</button>
      <button id="step">Step</button>

      <button onclick="setSpeed(0.5)">0.5×</button>
      <button onclick="setSpeed(1)">1×</button>
      <button onclick="setSpeed(2)">2×</button>
    </div>
  </div>

  <script>
    // ----------------------------
    // Scenario C: 5 static + 1 loop
    // ----------------------------

    const PATH = "../assets/states-static/scenarioC";
    const LOOP_DT = 10; // C1a: fast count segment (tweak)

    // NOTE:
    // - C1 static
    // - C1a loop: working 999->1, blocked 1->999
    // - C2..C5 static
    // - Flow lines ON whenever matching transfer is green (set send/ret booleans below)

    const steps = [
      { kind:"frame", frame:"C1",  dt: 1200, send:false, ret:false, showNums:false },

      // continuous count: show the SAME C1a frame while numbers change
      { kind:"loop",  frame:"C1a", dt: LOOP_DT, send:true,  ret:false, showNums:true,
        kStart: 1, kEnd: 999 },

      { kind:"frame", frame:"C2",  dt: 1200, send:true, ret:false, showNums:false },
      { kind:"frame", frame:"C3",  dt: 1200, send:true, ret:false,  showNums:false },
      { kind:"frame", frame:"C4",  dt: 1200, send:true, ret:true, showNums:false },
      { kind:"frame", frame:"C5",  dt: 1200, send:true, ret:false, showNums:false },
    ];

    let idx = 0;
    let speed = 1.0;
    let playing = true;
    let timer = null;

    // loop state
    let loopK = null; // blocked count: 1..999

    function setFlow(sendOn, retOn) {
      for (const id of ["sendL", "sendR"]) document.getElementById(id).classList.toggle("on", !!sendOn);
      for (const id of ["retL", "retR"])   document.getElementById(id).classList.toggle("on", !!retOn);
    }

    function setNumsVisible(on) {
      document.getElementById("nums").classList.toggle("on", !!on);
    }

    function setNums(working, blocked) {
      document.getElementById("nWorking").textContent = String(working);
      document.getElementById("nBlocked").textContent = String(blocked);
    }

    // ---------------------------------------
    // Background: HARD, synchronous swap
    // ---------------------------------------
    let front = "A";

    function hardSwap(frameName) {
      const src = `${PATH}/${frameName}.png`;

      const A = document.getElementById("frameA");
      const B = document.getElementById("frameB");
      const frontEl = (front === "A") ? A : B;
      const backEl  = (front === "A") ? B : A;

      frontEl.src = src;
      frontEl.classList.add("show");
      backEl.classList.remove("show");
    }

    function currentStateLabel(step, extra="") {
      return `${step.kind}:${step.frame}${extra ? " " + extra : ""}`;
    }

    function render() {
      const step = steps[idx];

      hardSwap(step.frame);
      setFlow(step.send, step.ret);
      setNumsVisible(step.showNums);

      if (step.kind === "loop") {
        const blocked = loopK;        // 1..999
        const working = 1000 - blocked; // 999..1
        setNums(working, blocked);
      }

      document.getElementById("status").textContent =
        `step=${idx+1}/${steps.length} | ${currentStateLabel(step, step.kind==="loop" ? `k=${loopK}` : "")} | send=${step.send} ret=${step.ret} | dt=${step.dt}ms | speed=${speed}x`;
    }

    function enterStep() {
      const step = steps[idx];
      loopK = (step.kind === "loop") ? step.kStart : null;
      render();
    }

    function advanceOne() {
      const step = steps[idx];

      if (step.kind === "loop") {
        if (loopK < step.kEnd) {
          loopK += 1;
          render();
          return;
        }
        // finished loop -> next step
        loopK = null;
        idx = (idx + 1) % steps.length;
        enterStep();
        return;
      }

      idx = (idx + 1) % steps.length;
      enterStep();
    }

    function scheduleNext() {
      if (!playing) return;
      const step = steps[idx];
      const dt = Math.max(2, Math.round(step.dt / speed));
      timer = setTimeout(() => {
        advanceOne();
        scheduleNext();
      }, dt);
    }

    // Buttons
    document.getElementById("step").onclick = () => advanceOne();

    document.getElementById("play").onclick = () => {
      playing = !playing;
      document.getElementById("play").textContent = playing ? "Pause" : "Play";
      if (timer) clearTimeout(timer);
      if (playing) scheduleNext();
    };

    function setSpeed(s) {
      speed = s;
      if (timer) clearTimeout(timer);
      if (playing) scheduleNext();
      render();
    }
    window.setSpeed = setSpeed;

    // ---------------------------------------
    // Startup: preload all frames once, then start
    // ---------------------------------------
    (function boot(){
      const stage = document.getElementById("stage");
      const uniqueFrames = [...new Set(steps.map(s => s.frame))];

      let remaining = uniqueFrames.length;
      function doneOne(){
        remaining -= 1;
        if (remaining <= 0) start();
      }

      for (const f of uniqueFrames) {
        const img = new Image();
        img.onload = doneOne;
        img.onerror = doneOne; // don't deadlock
        img.src = `${PATH}/${f}.png`;
      }

      function start(){
        stage.classList.add("ready");

        const A = document.getElementById("frameA");
        A.src = `${PATH}/${steps[0].frame}.png`;
        A.classList.add("show");
        document.getElementById("frameB").classList.remove("show");
        front = "A";

        enterStep();
        scheduleNext();
      }
    })();
  </script>
</body>
</html>